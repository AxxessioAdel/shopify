<!-- club-manager-simulator-ui\update-product.html -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Produkt aktualisieren</title>
  <style>
    #message {
      margin-top: 20px;
      font-weight: bold;
    }
    #message.success {
      color: green;
    }
    #message.error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Produkt aktualisieren</h1>

  <label for="productSelect">Produkt wÃ¤hlen:</label>
  <select id="productSelect">
    <option value="">Produkte werden geladen...</option>
  </select>

  <div id="editFormContainer" style="display:none;">
    <h2>Produkt bearbeiten:</h2>
    <form id="editProductForm">
      <label>Title: <input type="text" id="title" required /></label><br />
      <label>Description: <input type="text" id="description" required /></label><br />
      <label>Vendor: <input type="text" id="vendor" required /></label><br />
      <label>Product Type: <input type="text" id="product_type" required /></label><br />
      <label>Tags (comma separated): <input type="text" id="tags" /></label><br />
      <label>Image URL: <input type="text" id="image" required /></label><br />
      <label>Variants:</label>
      <div id="variantsContainer">
        <!-- Variants will be dynamically populated here -->
      </div>
    </form>

    <button type="button" id="previewButton">ðŸ‘€ Preview Changes</button>
    <button type="button" id="saveButton">ðŸ’¾ Save Changes</button>

    <h2>ðŸ“¦ Preview:</h2>
    <pre id="previewOutput"></pre>
  </div>

  <div id="message"></div>

  <script>
    let latestPayload = null;
    let selectedProductId = null;

    async function loadProducts() {
      try {
        const response = await fetch("http://localhost:3001/api/products");
        const result = await response.json();

        const select = document.getElementById("productSelect");
        select.innerHTML = "";

        result.products.forEach(product => {
          const option = document.createElement("option");
          option.value = product.id;
          option.textContent = `${product.title} (ID: ${product.id})`;
          select.appendChild(option);
        });

      } catch (error) {
        console.error("âŒ Fehler beim Laden der Produkte:", error);
        showMessage("Fehler beim Laden der Produktliste.", "error");
      }
    }

    async function loadProductDetails(productId) {
      try {
        const response = await fetch(`http://localhost:3001/api/products/${productId}`);
        const product = await response.json();

        console.log("ðŸ” API Response:", product);

        if (!product || !product.title) {
          console.error("âŒ Invalid API response: Missing product data.");
          showMessage("Fehler beim Laden des Produktes: Produktdaten fehlen.", "error");
          return;
        }

        document.getElementById("title").value = product.title || "";
        document.getElementById("description").value = product.body_html || "";
        document.getElementById("vendor").value = product.vendor || "";
        document.getElementById("product_type").value = product.product_type || "";
        document.getElementById("tags").value = product.tags || "";
        document.getElementById("image").value = (product.image && product.image.src) ? product.image.src : "";

        const variantsContainer = document.getElementById("variantsContainer");
        variantsContainer.innerHTML = "";

        if (product.variants && product.variants.length > 0) {
          product.variants.forEach(variant => {
            const variantDiv = document.createElement("div");
            variantDiv.classList.add("variant");
            variantDiv.innerHTML = `
              <label>Variant Title: <input type="text" value="${variant.title || ''}" data-id="${variant.id}" /></label><br />
              <label>Price: <input type="text" value="${variant.price || ''}" /></label><br />
            `;
            variantsContainer.appendChild(variantDiv);
          });
        } else {
          console.warn("âš ï¸ No variants found for the product.");
          showMessage("No variants found for the selected product.", "error");
        }

        document.getElementById("editFormContainer").style.display = "block";
      } catch (error) {
        console.error("âŒ Fehler beim Laden des Produktes:", error);
        showMessage("Fehler beim Laden des Produktes.", "error");
      }
    }

    document.getElementById("productSelect").addEventListener("change", (e) => {
      selectedProductId = e.target.value;
      if (selectedProductId) {
        loadProductDetails(selectedProductId);
      } else {
        document.getElementById("editFormContainer").style.display = "none";
      }
    });

    document.getElementById("previewButton").addEventListener("click", () => {
      const payload = buildPayloadFromForm();
      latestPayload = payload;
      document.getElementById("previewOutput").textContent = JSON.stringify(payload, null, 2);
      showMessage("Preview generiert.", "success");
    });

    document.getElementById("saveButton").addEventListener("click", async () => {
      if (!selectedProductId || !latestPayload) {
        showMessage("Bitte zuerst Produkt wÃ¤hlen und Preview generieren!", "error");
        return;
      }

      try {
        const response = await fetch(`http://localhost:3001/api/products/${selectedProductId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(latestPayload)
        });

        const result = await response.json();
        console.log("âœ… Produkt erfolgreich aktualisiert:", result);
        showMessage("âœ… Produkt erfolgreich aktualisiert!", "success");
      } catch (error) {
        console.error("âŒ Fehler beim Aktualisieren:", error);
        showMessage("âŒ Fehler beim Aktualisieren.", "error");
      }
    });

    function buildPayloadFromForm() {
      const title = document.getElementById("title").value;
      const description = document.getElementById("description").value;
      const vendor = document.getElementById("vendor").value;
      const product_type = document.getElementById("product_type").value;
      const tags = document.getElementById("tags").value.split(",").map(tag => tag.trim()).filter(tag => tag);

      const variants = [];
      const pricingGroups = document.querySelectorAll("#variantsContainer .variant");

      pricingGroups.forEach((group, index) => {
        const inputs = group.querySelectorAll("input[type='text']");
        const option1Input = inputs[0];
        const priceInput = inputs[1];

        if (option1Input && priceInput) {
          const option1 = option1Input.value.trim();
          const price = parseFloat(priceInput.value);
          const variantId = option1Input.dataset.id;

          if (option1 && !isNaN(price) && variantId) {
            variants.push({
              id: parseInt(variantId),
              option1: option1,
              price: price,
              position: index + 1
            });
          } else {
            console.warn(`âš ï¸ Invalid data for variant at position ${index + 1}`);
            showMessage(`Invalid data for variant at position ${index + 1}. Please check the form.`, "error");
          }
        } else {
          console.warn(`âš ï¸ Missing input fields for variant at position ${index + 1}`);
          showMessage(`Missing input fields for variant at position ${index + 1}. Please check the form.`, "error");
        }
      });

      if (variants.length === 0) {
        console.error("âŒ No valid variants found. Cannot proceed.");
        showMessage("No valid variants found. Please check the form.", "error");
        return null;
      }

      const image = document.getElementById("image").value;
        if (!image) {
            console.error("âŒ Image URL is required.");
            showMessage("Image URL is required.", "error");
            return null;
        }

      const options = [{
        name: "Version",
        values: variants.map(variant => variant.option1)
      }];

      const payload = {
        title: title,
        description: description,
        vendor: vendor,
        product_type: product_type,
        tags: tags,
        variants: variants,
        images: [image],
        options: options
      };

      return payload;
    }

    function showMessage(message, type) {
      const msgElem = document.getElementById("message");
      msgElem.textContent = message;
      msgElem.className = type;
    }

    loadProducts();
  </script>
</body>
</html>
